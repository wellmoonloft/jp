<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="Technology,Novel,Essay,Hexo" />
  <meta name="author" content="wellmoonloft" />
  <meta name="subtitle" content="Connotation fatty refuses to lose weight" />  
  <meta name="description" content="Technology, Essay, Gossip" />
  <meta name="msvalidate.01" content="4504B006DB2A6062F644FCDD2FC0575B" />
  <title>Flutter writes a Nas music player (2) | Well Talk</title>
  <link rel="apple-touch-icon" href="https://s2.loli.net/2022/12/30/lV2YzG9s86yK3OB.jpg">
  <link rel="icon" href="https://s2.loli.net/2022/12/30/lV2YzG9s86yK3OB.jpg">
  <!-- jquery3.6 -->
  <script async src="https://cdn.jsdelivr.net/gh/wellmoonloft/peach@v0.1.4/source/js/jquery.min-3.6.js"></script>
  <!-- hexo site css -->
  <link async href="https://cdn.jsdelivr.net/gh/wellmoonloft/peach@v0.1.5/source/css/base-min.css" rel="stylesheet">
  <link async href="https://cdn.jsdelivr.net/gh/wellmoonloft/peach@v0.1.4/source/iconfont/iconfont-min.css" rel="stylesheet">
  <link async href="https://cdn.jsdelivr.net/gh/wellmoonloft/peach@v0.1.4/source/css/github-markdown-min.css" rel="stylesheet">
  <link async href="https://cdn.jsdelivr.net/gh/wellmoonloft/peach@v0.1.4/source/css/highlight-min.css" rel="stylesheet">  
  <!-- fancybox -->
  <link async href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css" rel="stylesheet">  
  <script async src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js"></script>
  <script async src="https://cdn.jsdelivr.net/gh/wellmoonloft/peach@v0.1.4/source/js/fancybox.js"></script>
  <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-R4XRTRGM56"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-R4XRTRGM56');
    </script>  
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/en/atom.xml" title="Well Talk" type="application/atom+xml">
</head>
<body>
  <div id="app">
  <div class="header">
  <div class="avatar">
    <a href="https://www.igerm.ee/en"><img src="https://s2.loli.net/2022/12/30/lV2YzG9s86yK3OB.jpg" alt=""></a>
  </div>
  <div class="navbar">
    <ul>
      <li class="nav-item" data-path="/en/"><a href="/en/">Experience</a></li>
      <li class="nav-item" data-path="/en/categories/essay/"><a href="/en/categories/essay/">Essay</a></li>
      <li class="nav-item" data-path="/en/categories/novel/"><a href="/en/categories/novel/">Novel</a></li>
      <li class="nav-item" data-path="/en/about/"><a href="/en/about/">About</a></li>
    </ul>
  </div>
</div>
<script>
  let navs = document.querySelectorAll('.nav-item');
  let pagePath = window.location.pathname;
  for (let nav of navs) {
    let navPath = nav.getAttribute("data-path");
    if (navPath && navPath === pagePath) {
      nav.className = "nav-item active";
    }
  }
</script>       
  <div class="flex-container">          
  <!-- 同时引入 post.ejs 和 index.ejs -->
  
<div class="container post-details" id="post-details">
  <div class="post-content">
    <div class="post-title">Flutter writes a Nas music player (2)</div>
    <div class="post-attach">
      <span class="post-pubtime">
        <i class="iconfont icon-edit" title="Update time"></i> 2023-01-11 02:36
      </span>
      <span class="post-count">≈ 2.3kWords</span>
      <span class="post-count">≈ 14Minutes</span>
    </div>
    <div class="markdown-body"><blockquote>
<p><strong>Note</strong></p>
<p>This article was automatically translated using Google</p>
</blockquote>
<p>**Shout out! **If you want to do partial refresh through routing, you must write the routing yourself, don’t use the one that comes with flutter, it will make you feel crashed. Today, I switched to the global routing for the local refresh on the right side. After changing most of the code, I found that it was impossible to dynamically refresh while keeping the left and bottom <strong>Widget</strong>. I rewrote it in a fit of anger and it finally worked. But it wasted a long time. There is no way, in order to adjust the mobile terminal at that time, the left side can be used as a side-sliding window independently, decided to use <strong>ValueNotifier</strong> to hard-write the route, and then remove the current page highlight on the left side, mainly <strong>Although the Detail</strong> page can be tracked to the superior, it doesn’t matter if you want it or not. I wrote a huge 40 point headline and put it there, so I can’t miss it</p>
<p>At present, it can be used. The singer, album and all the logic of playing have been completed. There is also the home page after that. It is nothing more than a convenient use such as query point is playing. There are two more important points, search and lyrics. I don’t know if direct transcoding can realize complex and simple search. If not, you need to use API, which will waste query time</p>
<p><img src="https://s2.loli.net/2023/01/10/BCPjVHlazr2mK1R.jpg"></p>
<h3 id="1-Album-Waterfall"><a href="#1-Album-Waterfall" class="headerlink" title="1. Album Waterfall"></a>1. Album Waterfall</h3><p>This is what I have always wanted. Since I used Jellyfin, I feel that I have watched movies for nothing before. This kind of TV curtain wall is more handsome. Waterfall has ready-made wheels that can be used [flutter_staggered_grid_view](<a target="_blank" rel="noopener" href="https://pub.dev/">https://pub.dev</a> &#x2F;packages&#x2F;flutter_staggered_grid_view) is very simple to implement, just add it in <code>pubspec.yaml</code> and then <code>flutter pub get</code></p>
<p>It itself supports a variety of presentation methods, you can go to the homepage for details, but I chose <code>MasonryGridView</code>, which is most suitable for a large number of pictures. It is the same as building a ListView. There are three attributes that need to be defined here.</p>
<p><strong>crossAxisCount:</strong> How many columns</p>
<p><strong>mainAxisSpacing:</strong> line spacing</p>
<p><strong>crossAxisSpacing:</strong> Column spacing</p>
<p>I suggest doing a calculation, because if you fix <strong>Count</strong>, it will cause a problem. Dragging the form will make the picture very large, which is very strange</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Get the window size</span></span><br><span class="line">Size _size = MediaQuery.of(context).size;</span><br><span class="line"><span class="comment">//The right side is the part I want to display, first calculate the width, and then divide it by the width of the image you want to present</span></span><br><span class="line"><span class="built_in">double</span> _rightWidth = (_size. width - <span class="number">160</span>) / <span class="number">180</span>;</span><br><span class="line"><span class="comment">// then round down</span></span><br><span class="line"><span class="built_in">int</span> _count = _rightWidth.truncate();</span><br></pre></td></tr></table></figure>

<p>In this way, how do you drag the form? The width of the picture will only change in a small range, it will not be particularly exaggerated, and the construction is also very simple.</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MasonryGridView.count(</span><br><span class="line">               crossAxisCount: _count,</span><br><span class="line">               mainAxisSpacing: <span class="number">10</span>,</span><br><span class="line">               crossAxisSpacing: <span class="number">10</span>,</span><br><span class="line">               itemCount: _albums!.length,</span><br><span class="line">               itemBuilder: (context, index) &#123;</span><br><span class="line">                 <span class="keyword">return</span>...</span><br><span class="line">               &#125;</span><br></pre></td></tr></table></figure>

<p>You can seal a combination of <strong>Widget</strong> inside, such as adding two lines of text to a picture, and the effect will come out</p>
<p>Of course, you can do image caching. I wanted to do it at first, but I just didn’t know whether to save it in a folder or convert it to base64 and save it in the database.</p>
<p>In fact, it’s okay to not do caching, and the effect of lazy loading of pictures is still possible. Use <strong>frameBuilder</strong> to achieve the fade-in effect</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ClipRRect(</span><br><span class="line">   borderRadius: BorderRadius.circular(<span class="number">15</span>),</span><br><span class="line">   child: Image.network(</span><br><span class="line">     _temURL,</span><br><span class="line">     fit: BoxFit. cover,</span><br><span class="line">     frameBuilder: (context, child, frame, wasSynchronouslyLoaded) &#123;</span><br><span class="line">       <span class="keyword">if</span> (wasSynchronouslyLoaded) &#123;</span><br><span class="line">         <span class="keyword">return</span> child;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> AnimatedSwitcher(</span><br><span class="line">         child: frame != <span class="keyword">null</span></span><br><span class="line">           ? child</span><br><span class="line">           : Image.asset(<span class="string">&quot;assets/images/logo.jpg&quot;</span>),</span><br><span class="line">         duration: <span class="keyword">const</span> <span class="built_in">Duration</span>(milliseconds: <span class="number">2000</span>),</span><br><span class="line">       );</span><br><span class="line">     &#125;,</span><br><span class="line">   ),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h3 id="2-Music-playback"><a href="#2-Music-playback" class="headerlink" title="2. Music playback"></a>2. Music playback</h3><p>Playing a song is very simple, just <code>setAudioSource</code>, the trouble is the playlist, and the button operation to control the playlist. For example, the previous song is gone, but if the button is not grayed out, an error will be reported. All controls are performed using <code>ValueNotifier</code>. I understand it.</p>
<h4 id="2-1-Set-monitoring-variables"><a href="#2-1-Set-monitoring-variables" class="headerlink" title="2.1. Set monitoring variables"></a>2.1. Set monitoring variables</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Monitor the current resource ID. This is not only used for music playback, but also for obtaining singer pictures.</span></span><br><span class="line">ValueNotifier&lt;<span class="built_in">String</span>&gt; activeSongValue = ValueNotifier&lt;<span class="built_in">String</span>&gt;(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Listen to the current playlist</span></span><br><span class="line">ValueNotifier&lt;<span class="built_in">List</span>&gt; activeList = ValueNotifier&lt;<span class="built_in">List</span>&gt;([]);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Listen to the current song sequence</span></span><br><span class="line">ValueNotifier&lt;<span class="built_in">int</span>&gt; activeIndex = ValueNotifier&lt;<span class="built_in">int</span>&gt;(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Monitor the current song, similar to the above, just pass it to save a database query, because you need to fill in the song name, singer name and album name, otherwise you don’t need to pass it</span></span><br><span class="line">ValueNotifier&lt;<span class="built_in">Map</span>&gt; activeSong = ValueNotifier&lt;<span class="built_in">Map</span>&gt;(<span class="built_in">Map</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//Monitor whether out of order, this is to monitor the out of order button for triggering</span></span><br><span class="line">ValueNotifier&lt;<span class="built_in">bool</span>&gt; isShuffleModeEnabledNotifier = ValueNotifier&lt;<span class="built_in">bool</span>&gt;(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Monitor whether it is the first song</span></span><br><span class="line">ValueNotifier&lt;<span class="built_in">bool</span>&gt; isFirstSongNotifier = ValueNotifier&lt;<span class="built_in">bool</span>&gt;(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Monitor whether it is the last song, this is to block the button of the previous song and the next song to avoid error reporting</span></span><br><span class="line">ValueNotifier&lt;<span class="built_in">bool</span>&gt; isLastSongNotifier = ValueNotifier&lt;<span class="built_in">bool</span>&gt;(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>

<h4 id="2-2-Triggering"><a href="#2-2-Triggering" class="headerlink" title="2.2. Triggering"></a>2.2. Triggering</h4><p>After clicking the song in the song list, pass the id, song List and the index of the current song in the list, and then seal a Map</p>
<p>The main purpose is to get the picture URL of the song. This is not in the original Map. You need to go to the background to create a URL with the server address and identity information. Otherwise, it is more convenient to use the Songs instance directly.</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">onTap: () <span class="keyword">async</span> &#123;</span><br><span class="line">   activeSongValue.value = _tem.id;</span><br><span class="line">   <span class="comment">//List of album songs where the song is located</span></span><br><span class="line">   activeList.value = _songs!;</span><br><span class="line">   <span class="comment">// current song queue</span></span><br><span class="line">   activeIndex. value = index;</span><br><span class="line">   <span class="comment">// Assemble the current song</span></span><br><span class="line">   Map_activeSong = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">   <span class="built_in">String</span> _url = <span class="keyword">await</span> getCoverArt(_tem.id);</span><br><span class="line">   _activeSong[<span class="string">&quot;artist&quot;</span>] = _tem.artist;</span><br><span class="line">   _activeSong[<span class="string">&quot;url&quot;</span>] = _url;</span><br><span class="line">   _activeSong[<span class="string">&quot;title&quot;</span>] = _tem.title;</span><br><span class="line">   _activeSong[<span class="string">&quot;album&quot;</span>] = _tem.album;</span><br><span class="line">   activeSong.value = _activeSong;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-Receive-and-generate-playlist"><a href="#2-3-Receive-and-generate-playlist" class="headerlink" title="2.3. Receive and generate playlist"></a>2.3. Receive and generate playlist</h4><p>What is received here is <code>activeSongValue</code>, why not use <code>activeList</code> directly, because if you receive <code>activeList</code>, click other songs in the current list, and its default value will not change</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ValueListenableBuilder&lt;<span class="built_in">String</span>&gt;(</span><br><span class="line">    valueListenable: activeSongValue,</span><br><span class="line">    builder: ((context, value, child) &#123;</span><br><span class="line">    <span class="keyword">if</span> (value != <span class="string">&quot;1&quot;</span>) &#123;</span><br><span class="line">       setAudioSource();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>...</span><br></pre></td></tr></table></figure>

<p>If it is the default value <strong>1</strong>, it means that you have not selected music</p>
<p>When the value changes, start generating the playlist</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;<span class="keyword">void</span>&gt; setAudioSource() <span class="keyword">async</span> &#123;</span><br><span class="line">     <span class="comment">//1. Declaration</span></span><br><span class="line">     <span class="keyword">final</span> playlist = ConcatenatingAudioSource(</span><br><span class="line">       useLazyPreparation: <span class="keyword">true</span>,</span><br><span class="line">       shuffleOrder: DefaultShuffleOrder(),</span><br><span class="line">       children: <span class="keyword">await</span> _getPlayList(),</span><br><span class="line">     );</span><br><span class="line">     <span class="comment">//3. Add a playlist, by the way, set which song is currently playing</span></span><br><span class="line">     <span class="keyword">await</span> _player.setAudioSource(playlist,</span><br><span class="line">         initialIndex: activeIndex.value, initialPosition: <span class="built_in">Duration</span>.zero);</span><br><span class="line">     <span class="comment">//4. Start playing</span></span><br><span class="line">     _player.play();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   _getPlayList() <span class="keyword">async</span> &#123;</span><br><span class="line">     <span class="built_in">List</span>&lt;AudioSource&gt; children = [];</span><br><span class="line">     List_songs = activeList. value;</span><br><span class="line">     Take out the value passed when the trigger <span class="keyword">is</span> triggered</span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">var</span> element <span class="keyword">in</span> _songs) &#123;</span><br><span class="line">       Songs_song = element;</span><br><span class="line">       <span class="comment">//2. Go to the database to spell the address of the music file</span></span><br><span class="line">       <span class="built_in">String</span> _url = <span class="keyword">await</span> getSongStreamUrl(_song.id);</span><br><span class="line">       children.add(AudioSource.uri(<span class="built_in">Uri</span>.parse(_url), tag: _song.id)); <span class="comment">//Pay attention to setting the tag here, which can be used for later monitoring</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> children;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-4-Monitor-playback-changes"><a href="#2-4-Monitor-playback-changes" class="headerlink" title="2.4. Monitor playback changes"></a>2.4. Monitor playback changes</h4><p>When playing the next song, you need to replace the information of the song name and cover. At this time, you need to inject monitoring to operate</p>
<p>Just Audio has a number of different event streams, all of which can be listened to:</p>
<ul>
<li><strong>sequenceStream</strong>: This is the playlist in the order it was added, whenever the playlist changes, a new list will be generated here</li>
<li><strong>shuffleModeEnabledStream</strong>: ShuffleModeEnabledStream listener, open and close this mode, is a Boolean value</li>
<li><strong>shuffleIndicesStream</strong>: This is a list of shuffle integers pointing to the <code>sequenceStream</code> of items in the playlist (it does not shuffle itself). <code>shuffle</code> When this method is called on the audio player, a new list will be generated here.</li>
<li><strong>currentIndexStream</strong>: This stream notifies the index of the current song when the song first starts. This integer points to an audio source <code>sequenceStream</code> in the playlist</li>
<li><strong>loopModeStream</strong>:By default all songs in the list are played at once. However, you can also choose to repeat a single song or even a playlist, which is the loop mode, <code>LoopMode</code> This stream will generate a new value every time the loop mode changes</li>
</ul>
<p>Well, just look at the above. For monitoring, you can do it with one, that is, <strong>sequenceStateStream</strong>. Here, as long as one of the above five streams generates a new value, <code>sequenceStateStream</code> will generate a combined value type <code> SequenceState</code>, one top five, happy</p>
<p>First add this method call in <strong>initState</strong>, then..</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _listenForChangesInSequenceState() &#123;</span><br><span class="line">  <span class="comment">//when</span></span><br><span class="line">  <span class="comment">//Triggered when playing to the next song</span></span><br><span class="line">  _player.sequenceStateStream.listen((sequenceState) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="comment">//Roll when there is nothing</span></span><br><span class="line">    <span class="keyword">if</span> (sequenceState == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update the information of the currently playing song</span></span><br><span class="line">    <span class="keyword">final</span> currentItem = sequenceState. currentSource;</span><br><span class="line">    <span class="comment">//Get the id put in the tag when generating the playlist</span></span><br><span class="line">    final_title = currentItem?.tag <span class="keyword">as</span> <span class="built_in">String?</span>;</span><br><span class="line">    <span class="comment">//Go to the database to check the information to get the song information</span></span><br><span class="line">    <span class="keyword">final</span> _tem = <span class="keyword">await</span> getSong(_title. toString());</span><br><span class="line">    <span class="comment">//Update the current song id</span></span><br><span class="line">    activeSongValue.value = _title.toString();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Assemble the current song</span></span><br><span class="line">    Map_activeSong = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">    <span class="built_in">String</span> _url = <span class="keyword">await</span> getCoverArt(_tem[<span class="string">&quot;id&quot;</span>]);</span><br><span class="line">    _activeSong[<span class="string">&quot;artist&quot;</span>] = _tem[<span class="string">&quot;artist&quot;</span>];</span><br><span class="line">    _activeSong[<span class="string">&quot;url&quot;</span>] = _url;</span><br><span class="line">    _activeSong[<span class="string">&quot;title&quot;</span>] = _tem[<span class="string">&quot;title&quot;</span>];</span><br><span class="line">    _activeSong[<span class="string">&quot;album&quot;</span>] = _tem[<span class="string">&quot;album&quot;</span>];</span><br><span class="line">    activeSong.value = _activeSong;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The out-of-order monitoring here is useless for me, I wrote one myself (mainly I wrote the out-of-order logic first, and then made the playlist, I am too lazy to change it)</span></span><br><span class="line">    <span class="comment">// isShuffleModeEnabledNotifier.value = sequenceState.shuffleModeEnabled;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// get the playlist</span></span><br><span class="line">    <span class="keyword">final</span> playlist = sequenceState. effectiveSequence;</span><br><span class="line">    <span class="comment">//Judge the previous song and the next song, and then pass the value to the button for status judgment</span></span><br><span class="line">    <span class="keyword">if</span> (playlist.isEmpty || currentItem == <span class="keyword">null</span>) &#123;</span><br><span class="line">      isFirstSongNotifier. value = <span class="keyword">true</span>;</span><br><span class="line">      isLastSongNotifier. value = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      isFirstSongNotifier.value = playlist.first == currentItem;</span><br><span class="line">      isLastSongNotifier.value = playlist.last == currentItem;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-5-Fast-Forward-and-Fast-Rewind"><a href="#2-5-Fast-Forward-and-Fast-Rewind" class="headerlink" title="2.5. Fast Forward and Fast Rewind"></a>2.5. Fast Forward and Fast Rewind</h4><p>In fact, many people have canceled these two buttons now, because there is a progress bar, that is so convenient, but I have written the buttons before, so I will write them, it is a pity to delete them</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">IconButton(</span><br><span class="line">  icon: <span class="keyword">const</span> Icon(</span><br><span class="line">    Icons. fast_rewind,</span><br><span class="line">    color: kTextColor,</span><br><span class="line">  ),</span><br><span class="line">  onPressed: () &#123;</span><br><span class="line">    <span class="keyword">if</span> (widget. player. position. inSeconds - <span class="number">15</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      widget.player.seek(</span><br><span class="line">          <span class="built_in">Duration</span>(seconds: widget. player. position. inSeconds - <span class="number">15</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">),</span><br></pre></td></tr></table></figure>

<p>Here you need to make a judgment. If your current position minus the position you want to cancel is less than 0, don’t operate to avoid error reporting. It doesn’t matter if you move forward.</p>
<h4 id="2-6-Head-up-and-down"><a href="#2-6-Head-up-and-down" class="headerlink" title="2.6. Head up and down"></a>2.6. Head up and down</h4><p>Here you need to monitor the previously set values of <strong>isFirstSongNotifier</strong> and <strong>isLastSongNotifier</strong>. If you don’t filter, click on the first song when playing the first song, and click on the next song when you are playing the last song. there will be problems</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ValueListenableBuilder&lt;<span class="built_in">bool</span>&gt;(</span><br><span class="line">             valueListenable: isLastSongNotifier,</span><br><span class="line">             builder: (_, isLast, __) &#123;</span><br><span class="line">               <span class="keyword">return</span> IconButton(</span><br><span class="line">                 icon: Icon(</span><br><span class="line">                   Icons. skip_next,</span><br><span class="line">                   color: isLast ? badgeDark : kTextColor,</span><br><span class="line">                 ),</span><br><span class="line">                 onPressed: () &#123;</span><br><span class="line">                   (isLast) ? <span class="keyword">null</span> : widget. player. seekToNext();</span><br><span class="line">                 &#125;,</span><br><span class="line">               );</span><br><span class="line">             &#125;),</span><br></pre></td></tr></table></figure>

<p>Make a judgment, if there is a problem, just gray the button, and then pass a null in onPressed</p>
<h4 id="2-7-Single-loop-all-loop-random-play-stop-pause"><a href="#2-7-Single-loop-all-loop-random-play-stop-pause" class="headerlink" title="2.7. Single loop, all loop, random play, stop, pause"></a>2.7. Single loop, all loop, random play, stop, pause</h4><p>The difficulty lies in the above. After everything is written, the button part is relatively simple</p>
<p><strong>Single loop:</strong><code>player.setLoopMode(LoopMode.one);</code></p>
<p>**Loop all: ** <code>player.setLoopMode(LoopMode.all);</code></p>
<p><strong>Play in random order:</strong> <code>player.setShuffleModeEnabled(true);</code></p>
<h3 id="3-Monospace-font"><a href="#3-Monospace-font" class="headerlink" title="3. Monospace font"></a>3. Monospace font</h3><p>Since numbers are added before and after the progress bar of the song, an old-fashioned problem arises, that is, when the number goes from 1 to 0, the progress bar behind will be displaced, so the numbers here need to use monospaced fonts.</p>
<p>I used two fonts for the whole APP, one is <strong>NotoSansSC</strong>, which supports Chinese, Japanese, Korean and English, and it is very happy to use. It was dragged from the backup font of Jellyfin I set at that time. At that time, it was also used to display Chinese, Japanese, Korean and English subtitles, and it can be used here as well.</p>
<p>However, there is a problem with this font. It has two versions. The normal version can display both numbers and English, but the Mono version, which is a monospaced font, will display English and numbers in half-width, and it will become thinner. It looks like The head is very big, so I found a small monospaced font from Google Fonts, which is specially used for the number in front of the progress bar to avoid displacement</p>
<ol>
<li><p>Declare Asset</p>
<p> Still declared in pubspec.yaml</p>
</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># To add assets to your application, add an assets section, like this:</span></span><br><span class="line"><span class="attr">assets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">assets/images/</span></span><br><span class="line"><span class="attr">fonts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">family:</span> <span class="string">NotoSansSC</span></span><br><span class="line">    <span class="attr">fonts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">asset:</span> <span class="string">assets/fonts/NotoSansSC-Regular.otf</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">family:</span> <span class="string">ChivoMono</span></span><br><span class="line">    <span class="attr">fonts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">asset:</span> <span class="string">assets/fonts/ChivoMono-Regular.ttf</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Topical use</li>
</ol>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Text(</span><br><span class="line">        formatSongDuration(widget. position),</span><br><span class="line">        style: TextStyle(</span><br><span class="line">            color: borderColor, fontFamily: <span class="string">&#x27;ChivoMono&#x27;</span>, fontSize: <span class="number">12</span>),</span><br><span class="line">      )</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Global use</li>
</ol>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> MaterialApp(</span><br><span class="line">       debugShowCheckedModeBanner: <span class="keyword">false</span>,</span><br><span class="line">       title: <span class="string">&#x27;XiuMusic&#x27;</span>,</span><br><span class="line">       theme: ThemeData(fontFamily: <span class="string">&#x27;NotoSansSC&#x27;</span>),</span><br><span class="line">       home: MainScreen(),</span><br><span class="line">     );</span><br></pre></td></tr></table></figure>



<h3 id="4-Todo-List"><a href="#4-Todo-List" class="headerlink" title="4. Todo List"></a>4. Todo List</h3><p>I have been playing with this thing for a week. When I am under a lot of pressure, writing code really relieves pressure, so I am not in a hurry to finish it, take it slowly</p>
<p><a target="_blank" rel="noopener" href="https://github.com/wellmoonloft/xiumusic#todo-list">Todo List</a> was updated directly on Github</p>
<p>In fact, it is already available, and those who are interested can come down and play, <a target="_blank" rel="noopener" href="https://github.com/wellmoonloft/xiumusic">XiuMusic</a></p>
<p><img src="https://s2.loli.net/2023/01/10/3Wj8w7QfbZJ9N4y.jpg"></p>
</div>
      
        <div class="prev-or-next">
          <div class="post-foot-prev">
              <a href="/en/experience/Flutter%20writes%20a%20Nas%20music%20player%20(3)/" target="_self">
                <i class="iconfont icon-chevronleft"></i>  
                <span>Flutter writes a Nas music player (3)</span> 
              </a>
          </div>
          <div class="post-foot-next">
              <a href="/en/experience/Flutter%20writes%20a%20Nas%20music%20player%20(1)/" target="_self">
                <span>Flutter writes a Nas music player (1)</span>
                <i class="iconfont icon-chevronright"></i>             
              </a> 
          </div>
        </div>
      
    </div>
    
<div class="post-catalog" id="catalog">
  <div class="title">Contents</div>
  <div class="catalog-content">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Album-Waterfall"><span class="toc-text">1. Album Waterfall</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Music-playback"><span class="toc-text">2. Music playback</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-Set-monitoring-variables"><span class="toc-text">2.1. Set monitoring variables</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-Triggering"><span class="toc-text">2.2. Triggering</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-Receive-and-generate-playlist"><span class="toc-text">2.3. Receive and generate playlist</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-Monitor-playback-changes"><span class="toc-text">2.4. Monitor playback changes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-Fast-Forward-and-Fast-Rewind"><span class="toc-text">2.5. Fast Forward and Fast Rewind</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-Head-up-and-down"><span class="toc-text">2.6. Head up and down</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-Single-loop-all-loop-random-play-stop-pause"><span class="toc-text">2.7. Single loop, all loop, random play, stop, pause</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Monospace-font"><span class="toc-text">3. Monospace font</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Todo-List"><span class="toc-text">4. Todo List</span></a></li></ol>
  </div>
</div>
<script async src="https://cdn.jsdelivr.net/gh/wellmoonloft/peach@v0.1.4/source/js/catalog.js"></script>


    <div class="comments-container">
  <script src="https://utteranc.es/client.js"
        repo="wellmoonloft/repo_wellmoonloft"
        issue-term="pathname"
        label="comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
  </script>
</div>
  </div>

  <div class="footer">
  <div class="social">
    <ul>
      <li><a title="rss" href="/en/atom.xml"><i class="iconfont icon-rss"></i></a></li>
    </ul>
  </div>
  <div class="footer-more">
      <a href="https://www.igerm.ee/en/">Copyright © wellmoonloft 2024</a>  
  </div><div class="footer-more">
      <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges ｜ Powered by Hexo</a>  
  </div>
</div>
  </div>
  <div style="position: fixed;right: 2.2rem;top: 2.2rem;font-weight: bold;font-size: 1.6rem;">
  <a href="https://www.igerm.ee"> CN</a>
  <a href="https://www.igerm.ee/jp"> JP</a>
  <a href="https://www.igerm.ee/en"> EN</a>
  </div><div class="back-to-top hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>
<script async src="https://cdn.jsdelivr.net/gh/wellmoonloft/peach@v0.1.4/source/js/backtoTop.js"></script>
  <div class="search-icon" id="search-icon">
    <a href="javascript: void(0)"><i class="iconfont icon-search"></i></a>
  </div>
  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)"><i class="iconfont icon-search"></i></a>
        </span><input type="text" class="search-input" id="search-input" placeholder="Search...">
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)"><i class="iconfont icon-close"></i></a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>
  <script async src="https://cdn.jsdelivr.net/gh/wellmoonloft/peach@v0.1.6/source/js/search.js"></script>
  </div>
</body>
</html>